## Сообщения в MQTT канал, отправляемые по инициативе устройства

https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC

MQTT протокол обеспечивает двунаправленную передачу сообщений - как со стороны управляющей программы (браузерной панели управления) в устройство,
так и из устройства в управляющую программу по инициативе устройства.  

Наличие двустороннего канала связи позволяет устройству инициативно уведомлять управляющего о событиях, произошедших в устройстве.

Список ключей и формат возвращаемых значений приведены в таблице  


  | X   | **Ключ** | **Ответ**       | **Значение** 
  | --- | -------- | --------------- | -------- 
  | X | **W**    |**W:число**        | ширина матрицы
  | X | **H**    |**H:число**        | высота матрицы
  | X | **AA**   |**AA:[текст]**     | пароль точки доступа
  | X | **AD**   |**AD:число**       | продолжительность рассвета, мин
  | X | **AE**   |**AE:число**       | эффект, использующийся для будильника
  | X | **AO**   |**AO:X**           | включен будильник 0-нет, 1-да
  | X | **AL**   |**AL:X**           | сработал будильник 0-нет, 1-да
  | X | **AM1T** |**AM1T:HH MM**     | час 00..23 и минуты 00..59 включения режима 1, разделенные пробелом
  | X | **AM1A** |**AM1E:NN**        | номер эффекта режима 1:   -3 - не используется; -2 - выключить матрицу; -1 - ночные часы; 0 - включить случайный с автосменой; 1 - номер режима из списка EFFECT_LIST
  | X | **AM2T** |**AM2T:HH MM**     | час 00..23 и минуты 00..59 включения режима 2, разделенные пробелом
  | X | **AM2A** |**AM2E:NN**        | номер эффекта режима 1:   -3 - не используется; -2 - выключить матрицу; -1 - ночные часы;  0 - включить случайный с автосменой; 1 - номер режима из списка EFFECT_LIST
  | X | **AM3T** |**AM3T:HH MM**     | час 00..23 и минуты 00..59 включения режима 3, разделенные пробелом
  | X | **AM3A** |**AM3E:NN**        | номер эффекта режима 1:   -3 - не используется; -2 - выключить матрицу; -1 - ночные часы; 0 - включить случайный с автосменой; 1 - номер режима из списка EFFECT_LIST
  | X | **AM4T** |**AM4T:HH MM**     | час 00..23 и минуты 00..59 включения режима 4, разделенные пробелом
  | X | **AM4A** |**AM4E:NN**        | номер эффекта режима 1:   -3 - не используется; -2 - выключить матрицу; -1 - ночные часы;  0 - включить случайный с автосменой; 1 - номер режима из списка EFFECT_LIST
  | X | **AN**   |**AN:[текст]**     | имя точки доступа
  | X | **AT**   |**AT: DW HH MM**   | часы-минуты времени будильника для дня недели DW 1..7 -> например "AT:1 09 15"
  | X | **AU**   |**AU:X**           | создавать точку доступа 0-нет, 1-да
  | X | **AW**   |**AW:число**       | битовая маска дней недели будильника b6..b0: b0 - пн .. b7 - вс
  | X | **BE**   |**BE:число**       | контрастность эффекта
  | X | **BR**   |**BR:число**       | яркость
  | X | **C1**   |**C1:цвет**        | цвет режима "монохром" часов оверлея; цвет: 192,96,96 - R,G,B
  | X | **C2**   |**C2:цвет**        | цвет режима "монохром" бегущей строки; цвет: 192,96,96 - R,G,B
  | X | **CС**   |**CС:X**           | режим цвета часов оверлея: 0,1,2
  | X | **CE**   |**CE:X**           | оверлей часов вкл/выкл, где Х = 0 - выкл; 1 - вкл (использовать часы в эффектах)
  | X | **CK**   |**CK:X**           | размер горизонтальных часов, где Х = 0 - авто; 1 - малые 3x5; 2 - большие 5x7 
  | X | **CL**   |**CL:цвет**        | цвет рисования в формате RRGGBB
  | X | **CO**   |**CO:X**           | ориентация часов: 0 - горизонтально, 1 - вертикально
  | X | **CT**   |**CT:X**           | режим цвета текстовой строки: 0,1,2
  | X | **DC**   |**DC:X**           | показывать дату вместе с часами 0-нет, 1-да
  | X | **DD**   |**DD:число**       | время показа даты при отображении часов (в секундах)
  | X | **DI**   |**DI:число**       | интервал показа даты при отображении часов (в секундах)
  | X | **DM**   |**DM:Х**           | демо режим, где Х = 0 - ручное управление; 1 - авторежим
  | X | **DW**   |**DW:X**           | показывать температуру вместе с малыми часами 0-нет, 1-да
  | X | **EF**   |**EF:число**       | текущий эффект - id
  | X | **EN**   |**EN:[текст]**     | текущий эффект - название
  | X | **IP**   |**IP:xx.xx.xx.xx** | Текущий IP адрес WiFi соединения в сети
  | X | **IT**   |**IT:число**       | время бездействия в секундах
  | X | **LE**   |**LE:[список]**    | список эффектов, разделенный запятыми, ограничители [] обязательны
  | X | **LF**   |**LF:[список]**    | список файлов эффектов считанных с SD-карты, разделенный запятыми, ограничители [] обязательны
  | X | **LT**   |**LT:[список]**    | список текстовых строк, разделенный '~', ограничители [] обязательны
  | X | **MA**   |**MA:число**       | номер файла звука будильника из SD:/01
  | X | **MB**   |**MB:число**       | номер файла звука рассвета из SD:/02
  | X | **MD**   |**MD:число**       | сколько минут звучит будильник, если его не отключили
  | X | **MP**   |**MP:папка~файл**  | номер папки и файла звука который проигрывается, номер папки и звука разделены '~'
  | X | **MU**   |**MU:X**           | использовать звук в будильнике 0-нет, 1-да
  | X | **MV**   |**MV:число**       | максимальная громкость будильника
  | X | **MX**   |**MX:X**           | MP3 плеер доступен для использования 0-нет, 1-да
  | X | **NA**   |**NA:[текст]**     | пароль подключения к сети
  | X | **NB**   |**NB:Х**           | яркость цвета ночных часов, где Х = 1..255
  | X | **NC**   |**NС:Х**           | цвет ночных часов, где Х = 0 - R; 1 - G; 2 - B; 3 - C; 4 - M; 5 - Y;
  | X | **NP**   |**NP:Х**           | использовать NTP, где Х = 0 - выкл; 1 - вкл
  | X | **NS**   |**NS:[текст]**     | сервер NTP, ограничители [] обязательны
  | X | **NT**   |**NT:число**       | период синхронизации NTP в минутах
  | X | **NW**   |**NW:[текст]**     | SSID сети подключения
  | X | **NZ**   |**NZ:число**       | часовой пояс -12..+12
  | X | **OF**   |**OF:X**           | выключать часы вместе с лампой 0-нет, 1-да
  | X | **OM**   |**OM:X**           | сколько ячеек осталось свободно для хранения строк
  | X | **PD**   |**PD:число**       | продолжительность режима в секундах
  | X | **PS**   |**PS:X**           | состояние программного вкл/выкл панели 0-выкл, 1-вкл
  | X | **PW**   |**PW:число**       | ограничение по току в миллиамперах
  | X | **QA**   |**QA:X**           | использовать MQTT 0-нет, 1-да
  | X | **QD**   |**QD:число**       | задержка отправки сообщения MQTT
  | X | **QP**   |**QP:число**       | порт подключения к MQTT серверу
  | X | **QR**   |**QR:X**           | топик использует префикс в виде имени пользователя для формирования топика
  | X | **QS**   |**QS:[text]**      | имя MQTT сервера, например QS:[srv2.clusterfly.ru]
  | X | **QU**   |**QU:[text]**      | имя пользователя MQTT соединения, например QU:[user_af7cd12a]
  | X | **QW**   |**QW:[text]**      | пароль MQTT соединения, например QW:[pass_eb250bf5]
  | X | **QZ**   |**QZ:X**           | сборка поддерживает MQTT 0-нет, 1-да
  | X | **RM**   |**RM:Х**           | смена режимов в случайном порядке, где Х = 0 - выкл; 1 - вкл
  | X | **S1**   |**S1:[список]**    | список звуков будильника, разделенный запятыми, ограничители [] обязательны
  | X | **S2**   |**S2:[список]**    | список звуков рассвета, разделенный запятыми, ограничители [] обязательны
  | X | **SC**   |**SC:число**       | скорость смещения часов оверлея
  | X | **SD**   |**SD:X**           | наличие и доступность SD карты: Х = 0 - нат SD карты; 1 - SD карта доступна
  | X | **SE**   |**SE:число**       | скорость эффектов
  | X | **SS**   |**SS:число**       | параметр #1 эффекта
  | X | **SQ**   |**SQ:спец**        | параметр #2 эффекта; спец - "L>val>itrm1,item2,..itemN" - список, где val - текущее, далее список; "C>x>title" - чекбокс, где x=0 - выкл, x=1 - вкл; title - текст чекбокса
  | X | **ST**   |**ST:число**       | скорость смещения бегущей строки
  | X | **TE**   |**TE:X**           | оверлей текста бегущей строки вкл/выкл, где Х = 0 - выкл; 1 - вкл (использовать бегущую строку в эффектах)
  | X | **TI**   |**TI:число**       | интервал отображения текста бегущей строки
  | X | **TM**   |**TM:X**           |  в системе присутствует индикатор TM1637, где Х = 0 - нет; 1 - есть
  | X | **TS**   |**TS:строка**      | строка состояния кнопок выбора текста из массива строк: 36 символов 0..5, где<br>- 0 - серый - пустая<br>- 1 - черный - отключена<br>- 2 - зеленый - активна - просто текст, без макросов<br>- 3 - голубой - активна, содержит макросы кроме даты <br>- 4 - синий - активная, содержит макрос даты<br>- 5 - красный - для строки 0 - это управляющая строка  
  |   | **TY**   |**TY:[I:Z > текст]**| текст для строки, с указанным индексом I 0..35, Z 0..9,A..Z. Ограничители [] обязательны; текст ответа в формате: 'I:Z > текст'; 
  |   | **TZ**   |**TZ:[I:Z > текст]**| То же, что 'TY". Служит для фоновой загрузки всего массива сохраненных строк в смартфон для формирования элементов списка выбора строки. Получив этот ответ приложение на смартфоне берет следующий индекс и отправляет команду `'$13 3 I;'` для получения следующей строки.
  | X | **UC**   |**UC:X**           | использовать часы поверх эффекта 0-нет, 1-да
  | X | **UE**   |**UE:X**           | использовать эффект в демо-режиме 0-нет, 1-да
  | X | **UT**   |**UT:X**           | использовать бегущую строку поверх эффекта 0-нет, 1-да
  | X | **W1**   |**W1**             | текущая погода ('ясно','пасмурно','дождь'и т.д.)
  | X | **W2**   |**W2**             | текущая температура
  | X | **WC**   |**WC:X**           | Использовать цвет для отображения температуры в дневных часах  X: 0 - выключено; 1 - включено
  | X | **WN**   |**WN:X**           | Использовать цвет для отображения температуры в ночных часах  X: 0 - выключено; 1 - включено
  | X | **WR**   |**WR:число**       | Регион погоды Yandex
  | X | **WS**   |**WS:число**       | Регион погоды OpenWeatherMap
  | X | **WT**   |**WT:число**       | Период запроса сведений о погоде в минутах
  | X | **WU**   |**WU:X**           | Использовать получение погоды с сервера: 0 - выключено; 1 - Yandex; 2 - OpenWeatherMap
  | X | **WZ**   |**WZ:X**           | Прошивка поддерживает погоду USE_WEATHER == 1 - 0 - выключено; 1 - включено

```
  *** Примечание: Ключи, не отмеченные 'X' не могут использоваться в команде получения значения "$6 7|<ключи>", т.к. они используют внутренние индексы, 
                  предварительно устанавливаемые другими командами.

                  Ключи TX,TY,TZ не предназначены для получения значений командой "$6 7|TX TY TZ";
                  Получить значения этих ключей можно в ответ на команды:
                  "$13 2 N;"  - получить текст строки с индексом N (N -> 0..35) как есть, без обработки макросов
                  "$13 3 N;"  - получить текст строки с индексом N (N -> 0..35) c обработкой макросов для формирования списка выбора в приложении
                  "$18 3;"    - получить все настройки, связанные с бегущей строкой
```

### Уведомления

Уведомления отправляются в следующие топики MQTT канала:
 - **`nfo`** для информационных сообщений
 - **`err`** для сообщений об ошибках
 - **`ack`** для уведомлений, что команда принята и обработана, ответных данных не будет

### Информационные уведомления - тип NFO

- Нотификация о старте / перезапуске прошивки  
  `NFO:{"act":"START"}`  

- Нотификация о смене режима - какой эффект включен  
  `NFO:{"act":"MODE","id":24,"name":"'Мерцание'"}`  
  - **id**   - код режима (эффекта) который включен
  - **name** - название включенного эффекта
	   
- Нотификация о успешной / неуспешной синхронизации времени  
  `NFO:{"act":"TIME","server_name":"ru.pool.ntp.org","server_ip":"192.36.143.130","result":"REQUEST"}`  
  `NFO:{"act":"TIME","server_name":"ru.pool.ntp.org","server_ip":"192.36.143.130","result":"TIMEOUT"}`  
  `NFO:{"act":"TIME","server_name":"ru.pool.ntp.org","server_ip":"192.36.143.130","result":"OK","time":1601729577}`  
	   
- Нотификация о получении погоды с сервера погоды  
  `NFO:{"act":"WEATHER","region":66,"result":"TIMEOUT"}` - таймат ожидания ответа сервера  
  `NFO:{"act":"WEATHER","region":66,"result":"ERROR","status":"<http_code>"}` - неожиданный ответ сервера в `<http_code>` (ожидается `"OK 200"`)  
  `NFO:{"act":"WEATHER","region":66,"result":"ERROR","status":"unexpected answer"}` - получен ответ от сервера, который не содержит HTTP заголовков  
  `NFO:{"act":"WEATHER","region":66,"result":"ERROR","status":"json error"}` - полученный ответ - не информация о погоде в формате json  
  `NFO:{"act":"WEATHER","region":66,"result":"ERROR","status":"no data"}` - получен json-ответ, но в нем нет информации о погоде. Возможно в напросе указан неизвестный код региона погоды  
  `NFO:{"act":"WEATHER","region":66,"result":"OK","status":"<условия>","temp":23,"night":false,"icon":"skc","sky":"#57bbfe","town":"Omsk"}` - получен ответ, содержащий сведения о погоде  

  При удачном получении информации о погоде, в ответе содержатся следующие поля:
  - **region** - код региона для которого выполен запрос информации
  - **status** - текущие погодные условия - "ясно", "пасмурно", "дождь" и так далее
  - **temp**   - текущая температура
  - **night**  - true - темное время суток, false - светлое время суток
  - **icon**   - иконка погоды, соответствует текущим погодным условиям
  - **sky**    - цвет фона неба
  - **town**   - название населенного пункта, согласно переданному коду региона погоды
<br><br>

  | Код иконки         | Значения
  | ------------------ | --------
  | **bkn-minus-ra-d** | облачно с прояснениями, небольшой дождь (день)
  | **bkn-minus-sn-d** | облачно с прояснениями, небольшой снег (день)
  | **bkn-minus-sn-n** | облачно с прояснениями, небольшой снег (ночь)
  | **bkn-d**          | переменная облачность (день)
  | **bkn-n**          | переменная облачность (ночь)
  | **bkn-ra-d**       | переменная облачность, дождь (день)
  | **bkn-ra-n**       | переменная облачность, дождь (ночь)
  | **bkn-sn-d**       | переменная облачность, снег (день)
  | **bkn-sn-n**       | переменная облачность, снег (ночь)
  | **bl**             | метель
  | **fg-d**           | туман
  | **ovc**            | пасмурно
  | **ovc-minus-ra**   | пасмурно, временами дождь
  | **ovc-minus-sn**   | пасмурно, временами снег
  | **ovc-ra**         | пасмурно, дождь
  | **ovc-sn**         | пасмурно, снег
  | **ovc-ts-ra**      | пасмурно, дождь, гроза
  | **skc-d**          | ясно (день)
  | **skc-n**          | ясно (ночь)
   
	   
- Нотификация о срабатывании / отключении работающего будильника  
  `NFO:{"act":"ALARM","state":"on","type":"dawn"} `  - будильник - состояние "рассвет, без звука"  
  `NFO:{"act":"ALARM","state":"on","type":"alarm"}`  - будильник - состояние "звук"  
  `NFO:{"act":"ALARM","state":"off","type":"auto"}`  - будильник - состояние "выкл. автоматически после истечения времени"  
  `NFO:{"act":"ALARM","state":"off","type":"stop"}`  - будильник - состояние "выкл. кнопкой или командой из приложения"  
	   
- Нотификация о срабатывании авторежима 1..4  
  `NFO: {"act":"AUTO","mode":X,"text":"<text>"}`  
  - **mode** - код режима (эффекта) который включен
  - **text** - информационное сообщение в виде текста о наступившем событии

- Нотификация о начале и окончании показа текста бегущей строки  
  `NFO: {"act":"TEXT","run":true,"text":"<text>"}`  
  `NFO: {"act":"TEXT","run":false}`  
  - **run**  - true - начало отображения бегущей строки; false - окончание отображения текста бегущей строки
  - **text** - отображаемый текст

- Нотификация о загрузке и воспроизведении файла эффекта с SD-карты  
  `NFO: {"act":"SDCARD","result":"OK","file":"<file>"}`  
  `NFO: {"act":"SDCARD","result":"ERROR"}`  
  - **result** - true - эффект загружен и воспроизводится; false - ошибка загрузки файла эффекта
  - **file**   - имя файла <file>, загруженного с SD-карты

### Сообщения об ошибках - тип ERR 

Сообщение отправляется устройством в ответ на нераспознанную команду или некорректные параметры команды

  `ERR: {"message":"unknown page","text":"нет страницы с номером X"}` - ответ на команду `$18 X;`, где X- неизвестная страница  
  `ERR: {"message":"unknown command","text":"неизвестная команда '<команда>'"}` - ответ на несуществующую или нераспознанную команду `'<команда>'`  

### Сообщения о выполнении полученной команды - тип ACK

  `ACK` - cообщение состоит из единственной сигнатуры `ACK` и не содержит каких либо дополнительных параметров  
<br><br><br><br><br>
