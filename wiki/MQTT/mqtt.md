Для управления устройством может использоваться канал связи с использованием технологии MQTT (Message Queue Telemetry Transport).
В интернете можно найти множество статей, объясняющих принципы функционирования протокола, дающие понятия о подписках, публикациях и другие основные сведения.

Список публичных MQTT-серверов можно найти [здесь](https://github.com/mqtt/mqtt.github.io/wiki/public_brokers)  
Один из обзоров публичных MQTT серверов можно изучить на [этой](https://kotyara12.ru/pubs/iot/cloud_services/) странице.  

Как правило, сервера отличаются наличием наряду с платными, бесплатных сервисов, которые, однако, имеют ограничение на количество одновременных подключений к брокеру,
количество разрешенных запросов в период времени, наличие / отсутствие авторизации при подключении, поддержкy SSL и так далее.
Выберите подходящий именно вам MQTT брокер, изучите документацию на него, настройте подключение.  

В этой статье дана инструкция по настройке MQTT соединения для управления устройством на примере российского бесплатного MQTT-брокера [mqtt.4api.ru](https://mqtt.4api.ru/).

## Настройка сервера
Зарегистрируйтесь на сервере. Сервер предлагает вариант регистрации на основе одной из социальных сетей.
Выберите подходящую вам социальную сеть и нажмите на ее значок внизу окна регистрации.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-01.png)  

Если сеть запросит разрешение на использование аккаунта - подвердите, что вы согласны и осознаете свои действия.  
Когда согласие будет получено, вы увидете страницу вашего личного кабинета на MQTT-сервере.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-02.png)  

Вам предлагается на выбор два варианта MQTT-брокера - **[SRV.1]** и **[SRV.2]**. 
Для наших целей нет разницы, какой из серверов использовать. Их отличие - **[SRV.2]** поддерживает SSL соединение и
требует предварительной регистрации списка устройств, от которых будут приниматься сообщения.  

SSL в нашей прошивке не используется, сервер **[SRV.1]** проще в настройке - я предлагаю использовать его.
Кому нужно шифрование и ограничение списка подключаемых устройств - изучайте настройку брокера **[SRV.2]**.
Впрочем, какой сервер использовать - один из этих, другой или вообще свой собственный - решать вам.

Итак, я предлагаю использовать брокер **[SRV.1]**. 
Для просмотра параметров подключения к брокеру, перейдите по ссылке "Профиль" раздела **СЕРВЕР [SRV.1]**  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-03.png)  

Открывшаяся страница содержит сведения о параметрах подключения, ожидаемых брокером.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-06.png)  

Прежде всего, нас интересуют следующие поля:
1. Сервер - имя сервера, к которому будет выполняться подключение для создания MQTT-канала управления
2. Протокол|Порт - порт подключения **устройства**
3. Протокол|Порт - порт подключения **браузерной панели управления**
4. Пользователь - имя пользователя для подключения к серверу
5. Пароль - пароль для подключения к серверу

Пароль скрыт и не отображается. Нажмите надпись **"Запросить новый"**. Пароль отобразится вместо текста "Пароль скрыт". 
Запишите этот пароль. Здесь вы его можете увидеть лишь один раз. При каждом повторном нажатии на *"Запросить новый"* будет генерироваться новый пароль и вам придется
менять соответствующие настройки в прошивке.

Этих сведений достаточно для настройки соединения в скетче.  
Откройте в Arduino IDE файл прошивки **"a_def_soft.h"**. Найтите строки 308-322.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-08.png)  

Перенесите значения соответствующих настроек из окна "Профиль" настроек подключения в скетч  

```
#define DEFAULT_MQTT_SERVER "srv1.clusterfly.ru" // MQTT сервер
#define DEFAULT_MQTT_USER "user_af7cd12a"        // Имя mqtt-пользователя    (укажите имя пользователя для вашего соединения)
#define DEFAULT_MQTT_PASS "pass_eb250bf5"        // Пароль mqtt-пользователя (укажите пароль вашего соединения)
#define DEFAULT_MQTT_PORT 9124                   // Порт mqtt-соединения, tcp-канал
```

Строки 308-322 содержат недействительные учетные данные, которые используются для примера. Вам нужно заменить их своими.  

Обратите внимание на строку `#define A_DEF_PASS 1 ` определенную в выбранном вами профиля устройства в файле a_def_hard.ino

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-04.png)  

Если параметр `A_DEF_PASS` определен как **1** - это означает, что ваши настройки с чувствительными данными хранятся в отдельном 
файле с именем **"a_def_pass.h"**, который не включен в состав исходников.
Вам нужно будет создать этот файл и перенести в него настройки с вашими персональными учетными данными.

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-04a.png)  

Если параметр `A_DEF_PASS` определен как **0** - это оначает, чтонастройки вашего аккаунта для подключения к MQTT-серверу 
задаются непосредстванно в строках 308-322 вкетча в файле **"a_def_soft.h"**.  

### Идентификатор клиента

Строка 25 файла **"a_def_hard.h"** содержит общий идентификатор класса устройств этого проекта - все устройства это устройства - **"WiFiPanel"**. 
Конкретный профиль устройства задается значением DEVICE_ID, объявленным в в строке 26. 

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-09.png)  

Комбинация HOST_NAME и DEVICE_ID образуют 
  1) Имя клиента при подключении к MQTT-серверу
  2) Начальную часть топика публикации сообщений MQTT-брокеру

Так, идентификатор клиента для профиля `DEVICE_ID 0` в этом примере - **"WiFiPanel-0"**, и создается по правилу: `HOST_NAME + "-" + DEVICE_ID`  

Итак, параметры соединения определены, прошивку можно загружать в устройство.  
После того как прошивка загружена и стартовала, в мониторе порта будет виден лог подключения.  
Если все прошло успешно, вы увидите примерно следующее:  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-16.png)  

Проверить установку соединения можно в разделе "Web-client" личного кабинета. Нажмите на указанную ссылку  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-05.png)  

На странице Web-клиента укажите свой пароль полученный ранее. Нажмите кнопку "Подключиться".  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-05a.png)  

В поле "Топик" введите префикс в виде имени пользователя (сервер требует эту часть как префикс топика), идентификатор устройства и строку топика публикации.
Как пример в данном случае строка топика будет **"user_af7cd12a/WiFiPanel-0/cmd"**.

В поле команды введите какую-нибудь подходящую команду из [API управления устройством](https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC).
Нажмите кнопку "Отправить". Если все сделано правильно, в мониторе порта вы увидите запись о входящей команде и результат ее выполнения в логе и на матрице.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-12.png)  

Тем не менее данный Web-client ограничен в своих возможностях и мало на что годится. 

## Панель управления

Для управления устройством и наблюдения за его функционированием удобнее использовать более специализированную консоль, например [эту](http://client.mqtt.4api.ru/).  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-15.png)  

Заполните поля, необходимые для подключения к нашему MQTT-брокеру.  
- В поле "Host" - имя MQTT-сервера из настроек - "srv1.clusterfly.ru"  
- В поле "Port" - номер порта Websocket - 9123  
- В поле "Client ID" - идентификатор клиента управляющей панели - оставьте имя клиента, сгенерированное по-умолчанию  
- В поле "Username" - имя вашего пользователя для подключения к брокеру (в нашем примере - "user_af7cd12a")  
- В поле "Password" - пароль из настроек выше (в нашем примере - "pass_eb250bf5")  
- Нажмите кнопку "Подключить"  

Если все идентификационные данные введены верно и сервер доступен, панель параметров подключения свернется, индикатор станет зеленого цвета - connected.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-10.png)  

Следующий шаг - регистрация топиков, которые брокер ожидает от устройства. Нажмите кнопку "Add New Topic Suscription". 
В открывшейся панели введите название топика, выберите цвет пометки сообщений и нажмите кнопку "Subscribe"  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-14.png)  

Используемый нами брокер ожидает топик подписки, сформированный по следующему правилу:  
MQTT_USER + "/" + HOST_NAME + "-" - DEVICE_ID + "/" + TOPIC_XXX  
что в нашем случае означает *user_af7cd12a/WiFiPanel-0/#*  

В соответствии с правилами подписки, знак '#' означает - все "топики" ниже уровня *user_af7cd12a/WiFiPanel-0*  
Значени топиков, используемых в прошивке смотри в разделе [API управления устройством по каналу MQTT](https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC-%D0%BF%D0%BE-%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%D1%83-MQTT)  

При желании можно оформить отдельную подписку на каждый из топиков и задать им соответствующие цвета пометки сообщений.
В этом случае результат коммуникации панели управления с устройством может выглядеть примерно так  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-13.png)  

В разделе **Publish** панели управления, в поле "Topic" вы можете указать топик для отправки команд - *user_af7cd12a/WiFiPanel-0/cmd*,
затем в поле "Message" - какую-нибудь подходящую команду из [API управления устройством](https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC)
и отправить её, нажав кнопку "Publish". Реакцию устройства на команду можно видеть в мониторе порта и в секции "Messages" панели управления  

На этом настройка устройства для управления по каналу MQTT завершена.  
В настоящее время нет специальной программы для управления устройством через MQTT, хотя планы на ее создание есть.  

Если у вас есть соответствующие знания - вы можете настроить управление устройством через голосовые помощники, например - Яндекс Алиса или Google Assistant.
На данный момент есть несколько реализаций интеграции устройства в систему управления умным домом с помощью Home Assistant.
Одна из реализаций описана [тут](https://github.com/tarasifua/vvip-68-matrix-home-assistant-integration).  


## Настройка параметров MQTT в приложении

Настройки соединения с MQTT-сервером, сделанные в приложении используются как значения по-умолчанию и сохраняются в энергонезависимой памяти
при первой загрузке прошивки в микроконтроллер. При дальнейших запусках микроконтроллера настройки счмиываются из EEPROM и используются
при подключении к серверу. В любой момент настройки соединения можно изменить в программе на смартфоне.

Откройте приложение, подключитесь к устройству и перейдите на страницу "Настройки соединения"

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-17.png)  

Чекбокс "Использовать MQTT" позволяет временно включать и отключать канал управления MQTT.

Ниже расположены поля ввода значений настроек соединения:
1. Имя сервера MQTT
2. Имя пользователя
3. Пароль пользователя
4. Порт, используемый для подключения
5. Префикс для топика
6. Чекбокс включения пакетного режима
7. Задержка отправки сообщений.

Некоторые параметры очевидны - имя сервера, имя пользовател, пароль и порт.  
Другие требуют некоторого объяснения:

#### Префикс для топика

Некоторые сервера обязательно требуют наличие префикса при формирования топика публикации сообщений.
Описываемый сервер требует наличие префикса в виде имени пользователя перед изменяемой частью топика: `"user_af7cd12a/WiFiPanel-0/cmd"`.
Если для вашего сервера префикс не требуется - оставьте это поле пустым.

#### Чекбокс включения пакетного режима

Если сервер имеет ограничение на количество отправляемых сообщений в час или в сутки - отправляемые индивидуально сообщения для каждого измененного параметра
может быстро привести к исчерпанию лимита и сообщения сверх лимита будут отброшены сервером. Чтобы сократить количество отправляемых сообщений установите
чекбокс "Пакеты". В этом режиме передаваемые из приложения параметры будут группироваться в пакеты - сообщения в формате JSON, содержащем пары "Ключ-Значение".

```
{"W":48,"H":16,"DM":true,"PS":true,"PD":40,"IT":0,"AL":false,"RM":true,"PW":15000,"BR":6,
 "WU":1,"WT":15,"WR":62,"WS":1502026,"WC":true,"WN":true,"WZ":true,"EF":36,"EN":"Камин",
 "UE":true,"UT":true,"UC":true,"SE":"X","SS":"X","BE":176,"CE":true,"CC":0,"CO":0,"CK":0,
 "NC":0,"SC":119,"C1":"255,255,255","DC":true,"DD":3,"DI":240,"NP":true,"NT":60,"NZ":7,
 "NS":"ru.pool.ntp.org","DW":true,"OF":false,"TM":false,"AW":0,
 "AT":"1 0 0|2 0 0|3 0 0|4 0 0|5 0 0|6 0 0|7 0 0","AD":10,"AE":43,"MX":false,"AU":false,
 "AN":"PanelAP","NW":"AlvaNet","IP":"192.168.0.98","QZ":true,"QA":true,"QP":9124,
 "QS":"srv1.clusterfly.ru","QU":"user_eada9d0d","QD":100,"QR":"user_eada9d0d",
 "TE":true,"TI":90,"TS":"524133333222223344224444220000000041","CT":0,
 "C2":"255,255,254","OM":886,"ST":188,"AM1T":"23 35","AM1A":-1,"AM2T":"00 00","AM2A":-2,
 "AM3T":"09 30","AM3A":0,"AM4T":"00 00","AM4A":-3}
```

При отключенном чекбоксе "Пакеты" значение каждого параметра передается индивидуально:

```
user_eada9d0d/WiFiPanel-0/stt/W	 >> 48
user_eada9d0d/WiFiPanel-0/stt/H	 >> 16
user_eada9d0d/WiFiPanel-0/stt/DM >> true
user_eada9d0d/WiFiPanel-0/stt/PS >> true
user_eada9d0d/WiFiPanel-0/stt/PD >> 40
user_eada9d0d/WiFiPanel-0/stt/IT >> 0
user_eada9d0d/WiFiPanel-0/stt/AL >> false
user_eada9d0d/WiFiPanel-0/stt/RM >> true
user_eada9d0d/WiFiPanel-0/stt/PW >> 15000
...
user_eada9d0d/WiFiPanel-0/stt/AT >> 1 0 0|2 0 0|3 0 0|4 0 0|5 0 0|6 0 0|7 0 0
user_eada9d0d/WiFiPanel-0/stt/AD >> 10
user_eada9d0d/WiFiPanel-0/stt/AE >> 43
user_eada9d0d/WiFiPanel-0/stt/MX >> false
user_eada9d0d/WiFiPanel-0/stt/AU >> false
user_eada9d0d/WiFiPanel-0/stt/EF >> 22
user_eada9d0d/WiFiPanel-0/stt/EN >> Водоворот
user_eada9d0d/WiFiPanel-0/stt/SQ >> C>1>Сегменты
```

#### Задержка отправки сообщений.

Если сервер имеет ограничение отправки сообщений не чаще чем одно сообщение в заданный интервал времени, например одно сообщение в секунду,
требуется установить значение задержки. Укажите в поле `"Задержка, мс"` количество миллисекунд, которое устройство будет выжидать перед 
отправкой следующего сообщения из очереди на сервер. Рекомендуется устанавливать значение превышающее указанный в ограничениях сервера интервал.
Так, для сервера с ограничением "одно сообщение в секунду" - **1000 мс** - значение задержки рекомендуется установитть в **1050 мс** для гарантированного
соблюдения минимального интервала. Если на сервере нет ограничений - укажите в этом поле значение **0**.
<br>

После того, как параметры сервера были сконфигурированы, нажмите кнопку "Сохранить".
Новые значения параметров вступают в силу немедленно после сохранения.
<br><br><br><br>